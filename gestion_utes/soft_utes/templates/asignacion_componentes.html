{% extends base_template %}
{% load static %}

{% block title %}Gesti√≥n de Componentes{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'asignacion_componentes.css' %}"> 
{% endblock %}

{% block content %}
<div class="container">
  <h2>‚öí Asignaci√≥n de Componentes a un Equipo Inform√°tico</h2>

  <div class="card">
    <div id="notificacion" class="cabecera-liberado" style="display: none;"></div>
    <div class="detalle-equipo ">
      <div><strong>N¬∫ de Serie</strong><div>{{ equipo.numeroSerie }}</div></div>
      <div><strong>Descripci√≥n</strong><div>{{ equipo.descripcionEquipo }}</div></div>
      <div><strong>Cod. Patrimonio</strong><div>{{ equipo.codigoPatrimonial }}</div></div>
      <div><strong>Fecha Adquisici√≥n</strong><div>{{ equipo.fechaRegistro|date:"d/m/Y" }}</div></div>
      <div><strong>Estado</strong><div>{{ equipo.estado }}</div></div>
      <div><strong>Observaci√≥n</strong><div>{{ equipo.observacionEquipo }}</div></div>
      <div><strong>Garant√≠a</strong><div>{{ equipo.a√±oGarantia }} a√±os</div></div>
    </div>

    <h3>Componentes Asignados</h3>

    <table class="tabla-componentes">
      <thead>
        <tr>
          <th>Componente</th>
          <th>N¬∫ de serie</th>
          <th>Descripci√≥n</th>
          <th>Marca</th>
          <th>Modelo</th>
          <th>Estado</th>
          <th>Operaciones</th>
        </tr>
      </thead>
      <tbody>
        {% for comp in componentes_asignados %}
        <tr>
          <td>{{ comp.idTipoComponente.nombre }}</td>
          <td>{{ comp.numeroSerie }}</td>
          <td>{{ comp.descripcionComponente }}</td>
          <td>{{ comp.idModelo.idMarca.nombreMarca }}</td>
          <td>{{ comp.idModelo.nombreModelo }}</td>
          <td><span class="estado asignado">Asignado</span></td>
          <td>
            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="componente_id" value="{{ comp.idComponente }}">
              <input type="hidden" name="accion" value="quitar">
              <button class="btn rojo">üóëÔ∏è Liberar componente</button>
            </form>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="7">No hay componentes asignados.</td></tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="pagination" style="margin-top: 10px;">
      {% if componentes_asignados.has_other_pages %}
      <span class="step-links">
        {% if componentes_asignados.has_previous %}
          <a href="?pagina_asignados=1&buscar_asignados={{ buscar_asignados }}">¬´ Primero</a>
          <a href="?pagina_asignados={{ componentes_asignados.previous_page_number }}&buscar_asignados={{ buscar_asignados }}">Anterior</a>
        {% endif %}

        <span>P√°gina {{ componentes_asignados.number }} de {{ componentes_asignados.paginator.num_pages }}</span>

        {% if componentes_asignados.has_next %}
          <a href="?pagina_asignados={{ componentes_asignados.next_page_number }}&buscar_asignados={{ buscar_asignados }}">Siguiente</a>
          <a href="?pagina_asignados={{ componentes_asignados.paginator.num_pages }}&buscar_asignados={{ buscar_asignados }}">√öltima ¬ª</a>
        {% endif %}
      </span>
      {% endif %}
    </div>
  </div>

  <div class="card">
    <h3>Lista de Componentes Disponibles</h3>
    <div style="display: flex; justify-content: space-between; gap: 1rem; margin-bottom: 10px;">
      <div></div>
      <form method="get" style="display: flex; gap: 10px;">
        <input type="text" name="buscar_disponibles" value="{{ buscar_disponibles }}" class="search-input" placeholder="üîç Buscar...">
        <button type="submit" class="btn azul">Buscar</button>
      </form>
    </div>

    <table class="tabla-componentes">
      <thead>
        <tr>
          <th>Item</th>
          <th>Componente</th>
          <th>N¬∫ de serie</th>
          <th>Descripci√≥n</th>
          <th>Marca</th>
          <th>Modelo</th>
          <th>Estado</th>
          <th>Operaciones</th>
        </tr>
      </thead>
      <tbody>
        {% for comp in componentes_disponibles %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td>{{ comp.idTipoComponente.nombre }}</td>
          <td>{{ comp.numeroSerie }}</td>
          <td>{{ comp.descripcionComponente }}</td>
          <td>{{ comp.idModelo.idMarca.nombreMarca }}</td>
          <td>{{ comp.idModelo.nombreModelo }}</td>
          <td><span class="estado activo">Disponible</span></td>
          <td>
            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="componente_id" value="{{ comp.idComponente }}">
              <input type="hidden" name="accion" value="asignar">
              <button class="btn azul">‚áÑ Asignar a Equipo</button>
            </form>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="8">No hay componentes disponibles.</td></tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="pagination" style="margin-top: 10px;">
      {% if componentes_disponibles.has_other_pages %}
      <span class="step-links">
        {% if componentes_disponibles.has_previous %}
          <a href="?pagina_disponibles=1&buscar_disponibles={{ buscar_disponibles }}">¬´ Primero</a>
          <a href="?pagina_disponibles={{ componentes_disponibles.previous_page_number }}&buscar_disponibles={{ buscar_disponibles }}">Anterior</a>
        {% endif %}

        <span>P√°gina {{ componentes_disponibles.number }} de {{ componentes_disponibles.paginator.num_pages }}</span>

        {% if componentes_disponibles.has_next %}
          <a href="?pagina_disponibles={{ componentes_disponibles.next_page_number }}&buscar_disponibles={{ buscar_disponibles }}">Siguiente</a>
          <a href="?pagina_disponibles={{ componentes_disponibles.paginator.num_pages }}&buscar_disponibles={{ buscar_disponibles }}">√öltima ¬ª</a>
        {% endif %}
      </span>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const forms = document.querySelectorAll('form');
const notificacion = document.getElementById('notificacion');

forms.forEach(form => {
  form.addEventListener('submit', function(event) {
    const accion = this.querySelector('input[name="accion"]')?.value;
    if (accion === "asignar") {
      event.preventDefault();
      mostrarNotificacion("‚úÖ Componente asignado correctamente", this);
    } else if (accion === "quitar") {
      event.preventDefault();
      mostrarNotificacion("üóëÔ∏è Componente liberado correctamente", this);
    }
  });
});

function mostrarNotificacion(mensaje, form) {
  notificacion.textContent = mensaje;
  notificacion.style.display = 'block';
  notificacion.style.backgroundColor = '#e6fffa';
  notificacion.style.border = '1px solid #38b2ac';
  notificacion.style.color = '#285e61';
  setTimeout(() => {
    notificacion.style.display = 'none';
    form.submit();
  }, 1500);
}
</script>
{% endblock %}