{% extends base_template %}
{% load static %}

{% block title %}Asignar Equipo a Acta{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'asignacion.css' %}">
{% endblock %}

{% block content %}
<div class="container">
  <h2>⚒ Asignación de Equipo Informático a Acta</h2>

  <div id="notificacion" class="cabecera-liberado" style="display: none;"></div>

  <div class="card">
    <div class="detalle-equipo">
      <div><strong>Código</strong> <div>{{ acta.idFormato.codigoFormato }}</div></div>
      <div><strong>Versión</strong> <div>{{ acta.idFormato.versionFormato }}</div></div>
      <div><strong>Cod-Req</strong> <div>{{ acta.codReq }}</div></div>
      <div><strong>Establecimiento</strong> <div>{{ acta.idEstablecimiento.NombreEstablecimiento }}</div></div>
      <div><strong>Personal</strong> <div>{{ acta.idPersonal.Nombres }} {{ acta.idPersonal.Apellidos }}</div></div>
    </div>

    {% if equipos_asignados %}
    <h3>Equipos Asignados</h3>
    <div style="display: flex; justify-content: space-between; gap: 1rem; margin-bottom: 10px;">
    </div>

    <table class="tabla-componentes">
      <thead>
        <tr>
          <th>Equipo</th>
          <th>Nº Serie</th>
          <th>Descripción</th>
          <th>Marca</th>
          <th>Modelo</th>
          <th>Estado</th>
          <th>Operaciones</th>
        </tr>
      </thead>
      <tbody>
        {% for asignacion in equipos_asignados %}
        <tr>
          <td>{{ asignacion.idEquipoInformatico.idTipoEquipo.nombre }}</td>
          <td>{{ asignacion.idEquipoInformatico.numeroSerie }}</td>
          <td>{{ asignacion.idEquipoInformatico.descripcionEquipo }}</td>
          <td>{{ asignacion.idEquipoInformatico.idModelo.idMarca.nombreMarca }}</td>
          <td>{{ asignacion.idEquipoInformatico.idModelo.nombreModelo }}</td>
          <td><span class="estado {{ asignacion.idEquipoInformatico.estado|lower }}">{{ asignacion.idEquipoInformatico.estado }}</span></td>
          <td>
            <form method="post" action="{% url 'liberar_equipo_acta' acta.idActaSalida asignacion.id %}">
              {% csrf_token %}
              <button class="btn rojo">✖ Liberar</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="pagination" style="margin-top: 10px;">
      {% if equipos_asignados.has_other_pages %}
      <span class="step-links">
        {% if equipos_asignados.has_previous %}
          <a href="?pagina_asignados=1&buscar_asignados={{ buscar_asignados }}">« Primero</a>
          <a href="?pagina_asignados={{ equipos_asignados.previous_page_number }}&buscar_asignados={{ buscar_asignados }}">Anterior</a>
        {% endif %}

        <span>Página {{ equipos_asignados.number }} de {{ equipos_asignados.paginator.num_pages }}</span>

        {% if equipos_asignados.has_next %}
          <a href="?pagina_asignados={{ equipos_asignados.next_page_number }}&buscar_asignados={{ buscar_asignados }}">Siguiente</a>
          <a href="?pagina_asignados={{ equipos_asignados.paginator.num_pages }}&buscar_asignados={{ buscar_asignados }}">Última »</a>
        {% endif %}
      </span>
      {% endif %}
    </div>
    {% else %}
    <p><em>No hay equipos asignados actualmente a esta acta.</em></p>
    {% endif %}
  </div>


  <div class="card">
    <h3>Lista de Equipos Disponibles</h3>
    <div style="display: flex; justify-content: space-between; gap: 1rem; margin-bottom: 10px;">
      <div></div>
      <div style="display: flex; gap: 10px;">
        <form method="get" style="display: flex; gap: 10px;">
          <input type="text" name="buscar_disponibles" value="{{ buscar_disponibles }}" class="search-input" placeholder="🔍 Buscar...">
          <button type="submit" class="btn azul">Buscar</button>
        </form>
      </div>
    </div>

    <table class="tabla-componentes">
      <thead>
        <tr>
          <th>Equipo</th>
          <th>Nº de Serie</th>
          <th>Descripción</th>
          <th>Patrimonio</th>
          <th>Marca</th>
          <th>Modelo</th>
          <th>Estado</th>
          <th>Operaciones</th>
        </tr>
      </thead>
      <tbody>
        {% for equipo in equipos %}
        <tr>
          <td>{{ equipo.idTipoEquipo.nombre }}</td>
          <td>{{ equipo.numeroSerie }}</td>
          <td>{{ equipo.descripcionEquipo }}</td>
          <td>{{ equipo.codigoPatrimonial }}</td>
          <td>{{ equipo.idModelo.idMarca.nombreMarca }}</td>
          <td>{{ equipo.idModelo.nombreModelo }}</td>
          <td><span class="estado {{ equipo.estado|lower }}">{{ equipo.estado }}</span></td>
          <td>
            <form method="post" class="form-asignacion">
              {% csrf_token %}
              <input type="hidden" name="idEquipoInformatico" value="{{ equipo.idEquipoInformatico }}">
              <button class="btn azul">⇄ Asignar a Acta</button>
            </form>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="9">No hay equipos disponibles para asignar.</td></tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="pagination" style="margin-top: 10px;">
      {% if equipos.has_other_pages %}
      <span class="step-links">
        {% if equipos.has_previous %}
          <a href="?pagina_disponibles=1&buscar_disponibles={{ buscar_disponibles }}">« Primero</a>
          <a href="?pagina_disponibles={{ equipos.previous_page_number }}&buscar_disponibles={{ buscar_disponibles }}">Anterior</a>
        {% endif %}

        <span>Página {{ equipos.number }} de {{ equipos.paginator.num_pages }}</span>

        {% if equipos.has_next %}
          <a href="?pagina_disponibles={{ equipos.next_page_number }}&buscar_disponibles={{ buscar_disponibles }}">Siguiente</a>
          <a href="?pagina_disponibles={{ equipos.paginator.num_pages }}&buscar_disponibles={{ buscar_disponibles }}">Última »</a>
        {% endif %}
      </span>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}


{% block extra_js %}
<script>
  const forms = document.querySelectorAll('.form-asignacion');
  const notificacion = document.getElementById('notificacion');

  forms.forEach(form => {
    form.addEventListener('submit', function(event) {
      event.preventDefault();
      mostrarNotificacion("✅ Equipo asignado correctamente", this);
    });
  });

  function mostrarNotificacion(mensaje, form) {
    notificacion.textContent = mensaje;
    notificacion.style.display = 'block';
    notificacion.style.backgroundColor = '#e6fffa';
    notificacion.style.border = '1px solid #38b2ac';
    notificacion.style.color = '#285e61';

    setTimeout(() => {
      notificacion.style.display = 'none';
      form.submit();
    }, 1500);
  }
</script>
{% endblock %}