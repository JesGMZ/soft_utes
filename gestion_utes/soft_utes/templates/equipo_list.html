{% extends base_template %}
{% load static %}

{% block title %}Gesti√≥n de Equipos Inform√°ticos{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'estilos_formularios.css' %}">
<link rel="stylesheet" href="{% static 'extras.css' %}">
<style>
  #formEquipo { display: none; }
  .btn.amarillo { background-color: #ecc94b; color: #1a202c; }
  .radio-row { align-items: center; }
  .radio-label { width: auto; margin-right: 15px; font-weight: 600; }
  .radio-group { display: flex; gap: 20px; align-items: center; }
  #grupoImagenPreview { align-items: center; gap: 10px; }

  .pagination {
    display: flex;
    gap: 8px;
    margin-top: 15px;
    justify-content: center;
  }
  .pagination button {
    padding: 5px 12px;
    border: none;
    border-radius: 5px;
    background: #e2e8f0;
    cursor: pointer;
  }
  .pagination button.active {
    background: #2b6cb0;
    color: white;
    font-weight: bold;
  }

  .select-row {
    padding: 6px;
    border-radius: 6px;
    border: 1px solid #ccc;
    background-color: #fff;
  }

  .equipo-form {
    border: 1px solid #cbd5e0;
    padding: 15px;
    margin-top: 10px;
    border-radius: 6px;
    background-color: #f7fafc;
  }

  .equipo-form h3 {
    margin-bottom: 10px;
  }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <h1>Equipos Inform√°ticos</h1>

  <div class="form-row">
    <label for="tipoVisual">Tipo de Equipo:</label>
    <select id="tipoVisual">
      <option value="">-- Seleccione --</option>
      {% for tipo in tipos %}
      <option value="{{ tipo.idTipoEquipo }}">{{ tipo.nombre }}</option>
      {% endfor %}
    </select>

    <label for="modeloLote">Modelo:</label>
    <select id="modeloLote">
      <option value="">-- Seleccione --</option>
      {% for modelo in modelos %}
      <option value="{{ modelo.idModelo }}">{{ modelo.nombreModelo }}</option>
      {% endfor %}
    </select>

    <label for="cantidadLote">Cantidad:</label>
    <input type="number" id="cantidadLote" min="1">

    <label for="fechaAdquisicionLote">Fecha de Compra:</label>
    <input type="date" id="fechaAdquisicionLote">

    <button type="button" id="registrarLoteBtn" class="btn-guardar">Registrar Lote</button>
  </div>

  <input type="hidden" id="idLote" name="idLote">
  <input type="hidden" id="modoFormulario" value="crear">

  <div id="formEquipo">
    <form id="formularioEquipo" method="POST" action="">
      {% csrf_token %}
      <input type="hidden" id="idEquipoInformatico" name="idEquipoInformatico">
      <input type="hidden" id="tipoHidden" name="idTipoEquipo">
      <div class="form-row">
        <label for="nombre">Nombre:</label>
        <input type="text" id="nombre" name="nombreEquipoInformatico" required>

        <label for="serie">N¬∫ de Serie:</label>
        <input type="text" id="serie" name="numeroSerie">

        <label for="modeloInput">Modelo:</label>
        <input type="text" id="modeloInput" list="listaModelos" autocomplete="off">
        <input type="hidden" id="modelo" name="idModelo">
        <datalist id="listaModelos">
          {% for modelo in modelos %}
            <option value="{{ modelo.nombreModelo }}" data-id="{{ modelo.idModelo }}" data-imagen="{% if modelo.Imagen %}{{ modelo.Imagen.url }}{% endif %}"></option>
          {% endfor %}
        </datalist>
      </div>

      <div class="form-row">
        <label for="patrimonio">Cod. Patrimonio:</label>
        <input type="text" id="patrimonio" name="codigoPatrimonial">

        <label for="garantia">A√±o de Garant√≠a:</label>
        <input type="number" id="garantia" name="a√±oGarantia">

        <label for="observacion">Observaci√≥n:</label>
        <input type="text" id="observacion" name="observacionEquipo">
      </div>

      <div class="form-row radio-row">
        <label class="radio-label">Tipo Descripci√≥n:</label>
        <div class="radio-group">
          <label><input type="radio" name="descripcionEquipo" value="De Marca" checked> De Marca</label>
          <label><input type="radio" name="descripcionEquipo" value="Compatible"> Compatible</label>
          <label><input type="radio" name="descripcionEquipo" value="Otros"> Otros</label>
        </div>
      </div>

      <div class="form-row" id="grupoImagenPreview" style="display: none;">
        <label>Imagen actual:</label>
        <img id="imagenPreview" src="" style="max-width: 120px; border: 1px solid #ccc; padding: 4px;">
      </div>

      <button type="submit" class="btn-guardar">Guardar</button>
      <button type="button" id="btnCancelarFormulario" class="btn-cancelar">Cancelar</button>
    </form>
  </div>

  <!-- CONTENEDOR DE EQUIPOS GENERADOS POR LOTE -->
  <div id="contenedorEquiposLote"></div>

  {% csrf_token %}
  <div class="card-lista">
    <div class="table-header">
      <h2>Lista de Equipos Inform√°ticos</h2>
      <div style="display: flex; justify-content: space-between; gap: 1rem;">
        <div>
          <label>Mostrar</label>
          <select id="mostrar">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
          </select>
          <span>registros</span>
        </div>
        <div>
          <input type="text" id="buscarEquipos" class="search-input" placeholder="üîç Buscar...">
          <select id="filtroEstado" class="select-row">
            <option value="">Todos</option>
            <option value="activo">ACTIVO</option>
            <option value="inactivo">INACTIVO</option>
          </select>
        </div>
      </div>
    </div>

    <div class="tabla-responsive">
      <table class="equipos-table">
        <thead>
          <tr>
            <th>Equipo</th>
            <th>N¬∞ Serie</th>
            <th>Patrimonio</th>
            <th>Nombre Equipo</th>
            <th>Estado</th>
            <th>Operaciones</th>
          </tr>
        </thead>
        <tbody>
          {% for equipo in equipos %}
          <tr>
            <td>{{ equipo.idTipoEquipo.nombre }}</td>
            <td>{{ equipo.numeroSerie }}</td>
            <td>{{ equipo.codigoPatrimonial }}</td>
            <td>{{ equipo.nombreEquipoInformatico }}</td>
            <td><span class="estado {{ equipo.estado|lower }}">{{ equipo.estado }}</span></td>
            <td>
              {% if equipo.estado == "ACTIVO" or equipo.estado == "ASIGNADO" %}
                <a href="{% url 'equipo_detalle' equipo.idEquipoInformatico %}" class="btn azul">Ver</a>
                <button class="btn amarillo"

                  data-id="{{ equipo.idEquipoInformatico }}"
                  data-nombre="{{ equipo.nombreEquipoInformatico }}"
                  data-serie="{{ equipo.numeroSerie|default:'' }}"
                  data-modelo="{% if equipo.idModelo %}{{ equipo.idModelo.idModelo }}{% endif %}"
                  data-tipo="{{ equipo.idTipoEquipo.idTipoEquipo }}"
                  data-patrimonio="{{ equipo.codigoPatrimonial|default:'' }}"
                  data-observacion="{{ equipo.observacionEquipo|default:'' }}"
                  data-garantia="{{ equipo.a√±oGarantia|default:'' }}"
                  data-descripcion="{{ equipo.descripcionEquipo }}"
                  data-estado="{{ equipo.estado }}"
                >Editar</button>
                <a href="{% url 'equipo_delete' equipo.idEquipoInformatico %}" class="btn rojo">Dar de Baja</a>
                <a href="{% url 'asignar_componentes' idEquipoInformatico=equipo.idEquipoInformatico %}" class="btn morado">Asignar Componentes</a>
              {% else %}
                <a href="{% url 'equipo_reactivar' equipo.idEquipoInformatico %}" class="btn verde"
                  onclick="return confirm('¬øDeseas reactivar este equipo?');">‚úÖ Reactivar</a>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>

      </table>
    </div>
    <p id="infoRegistros" style="font-size: 14px; color: #4a5568; margin-top: 10px;"></p>
    <div class="pagination" id="paginacion"></div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
  // URLs para las peticiones AJAX
  const URL_CREAR_EQUIPO = "{% url 'equipo_create' %}";
  const URL_LISTAR_EQUIPOS = "{% url 'equipo_list' %}";
  const URL_CREAR_LOTE = "{% url 'crear_lote' %}";
  const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value;

  document.addEventListener("DOMContentLoaded", () => {
    // Elementos del DOM
    const tablaEquipos = document.querySelector(".equipos-table tbody");
    const buscar = document.getElementById("buscarEquipos");
    const filtroEstado = document.getElementById("filtroEstado");
    const mostrar = document.getElementById("mostrar");
    const paginacion = document.getElementById("paginacion");
    const infoRegistros = document.getElementById("infoRegistros");

    // Variables para la paginaci√≥n
    let todasLasFilas = Array.from(tablaEquipos.querySelectorAll("tr"));
    let filasFiltradas = [...todasLasFilas];
    let paginaActual = 1;
    let filasPorPagina = parseInt(mostrar.value);

    function mostrarPagina(pagina) {
      const inicio = (pagina - 1) * filasPorPagina;
      const fin = inicio + filasPorPagina;
      todasLasFilas.forEach(fila => fila.style.display = 'none');
      const filasAMostrar = filasFiltradas.slice(inicio, fin);
      filasAMostrar.forEach(fila => fila.style.display = '');
      actualizarInfo(pagina);
      actualizarPaginacion(pagina);
    }

    function actualizarInfo(pagina) {
      const total = filasFiltradas.length;
      const inicio = total === 0 ? 0 : (pagina - 1) * filasPorPagina + 1;
      const fin = Math.min(inicio + filasPorPagina - 1, total);

      if (total === 0) {
        infoRegistros.textContent = "No se encontraron resultados.";
      } else if (total <= filasPorPagina) {
        infoRegistros.textContent = `Mostrando ${total} de ${total} registros`;
      } else {
        infoRegistros.textContent = `Mostrando ${inicio} a ${fin} de ${total} registros`;
      }
    }

    function actualizarPaginacion(pagina) {
      const totalPaginas = Math.ceil(filasFiltradas.length / filasPorPagina);
      paginacion.innerHTML = '';

      if (pagina > 1) {
        const prevBtn = document.createElement('button');
        prevBtn.textContent = 'Anterior';
        prevBtn.onclick = () => {
          paginaActual--;
          mostrarPagina(paginaActual);
        };
        paginacion.appendChild(prevBtn);
      }

      const maxBotones = 5;
      let inicioPagina = Math.max(1, pagina - Math.floor(maxBotones / 2));
      let finPagina = Math.min(totalPaginas, inicioPagina + maxBotones - 1);

      if (finPagina - inicioPagina + 1 < maxBotones) {
        inicioPagina = Math.max(1, finPagina - maxBotones + 1);
      }

      for (let i = inicioPagina; i <= finPagina; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        if (i === pagina) {
          btn.classList.add('active');
          btn.disabled = true;
        }
        btn.onclick = () => {
          paginaActual = i;
          mostrarPagina(paginaActual);
        };
        paginacion.appendChild(btn);
      }

      if (pagina < totalPaginas) {
        const nextBtn = document.createElement('button');
        nextBtn.textContent = 'Siguiente';
        nextBtn.onclick = () => {
          paginaActual++;
          mostrarPagina(paginaActual);
        };
        paginacion.appendChild(nextBtn);
      }
    }

    function aplicarFiltros() {
      const textoBusqueda = buscar.value.trim().toLowerCase();
      const estadoSeleccionado = filtroEstado.value.toLowerCase();

      filasFiltradas = todasLasFilas.filter(fila => {
        const celdas = fila.getElementsByTagName('td');
        let estado = '';
        for (let celda of celdas) {
          const estadoElement = celda.querySelector('.estado');
          if (estadoElement) {
            estado = estadoElement.textContent.trim().toLowerCase();
            break;
          }
        }

        const textoFila = fila.textContent.toLowerCase();
        const coincideTexto = textoBusqueda === '' || 
          Array.from(celdas).some(celda =>
            celda.textContent.toLowerCase().includes(textoBusqueda)
          );
        const coincideEstado = estadoSeleccionado === '' || estado === estadoSeleccionado;

        return coincideTexto && coincideEstado;
      });

      paginaActual = 1;
      mostrarPagina(paginaActual);
    }

    let timeoutBusqueda;
    buscar.addEventListener('input', () => {
      clearTimeout(timeoutBusqueda);
      timeoutBusqueda = setTimeout(aplicarFiltros, 300);
    });

    filtroEstado.addEventListener('change', aplicarFiltros);

    mostrar.addEventListener('change', () => {
      filasPorPagina = parseInt(mostrar.value);
      paginaActual = 1;
      mostrarPagina(paginaActual);
    });

    function inicializarTabla() {
      todasLasFilas = Array.from(tablaEquipos.querySelectorAll("tr"));
      filasFiltradas = [...todasLasFilas];
      aplicarFiltros();
    }

    const registrarLoteBtn = document.getElementById("registrarLoteBtn");
    if (registrarLoteBtn) {
      registrarLoteBtn.addEventListener("click", async () => {
        const modeloId = document.getElementById("modeloLote").value;
        const tipoId = document.getElementById("tipoVisual").value;
        const fecha = document.getElementById("fechaAdquisicionLote").value;
        const cantidad = parseInt(document.getElementById("cantidadLote").value);
        const tipoTexto = document.querySelector("#tipoVisual option:checked")?.text;
        const contenedor = document.getElementById("contenedorEquiposLote");

        if (!modeloId || !tipoId || !fecha || !cantidad) {
          alert("Debe completar todos los datos del lote.");
          return;
        }

        try {
          const formData = new FormData();
          formData.append("idModelo", modeloId);
          formData.append("idTipoEquipo", tipoId);
          formData.append("fechaAdquisicion", fecha);
          formData.append("cantidad", cantidad);

          const response = await fetch(URL_CREAR_LOTE, {
            method: "POST",
            headers: {
              "X-CSRFToken": csrfToken,
            },
            body: formData
          });

          if (!response.ok) throw new Error("Error al registrar lote.");

          const data = await response.json();
          const idLote = data.idLote;
          contenedor.innerHTML = "";

          for (let i = 1; i <= cantidad; i++) {
            const form = document.createElement("form");
            form.classList.add("card", "form-lote-generado");
            form.method = "POST";
            form.action = URL_CREAR_EQUIPO;

            form.innerHTML = `
              <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
              <input type="hidden" name="idModelo" value="${modeloId}">
              <input type="hidden" name="fechaAdquisicion" value="${fecha}">
              <input type="hidden" name="idTipoEquipo" value="${tipoId}">
              <input type="hidden" name="idLote" value="${idLote}">

              <div class="form-row">
                <label>Tipo de Equipo:</label>
                <input type="text" value="${tipoTexto}" readonly>
                <label>Nombre:</label>
                <input type="text" name="nombreEquipoInformatico" required>
                <label>N√∫mero de Serie:</label>
                <input type="text" name="numeroSerie" required>
                <label>C√≥digo Patrimonial:</label>
                <input type="text" name="codigoPatrimonial" required>
                <label>A√±o de Garant√≠a:</label>
                <input type="number" name="a√±oGarantia" required>
                <label>Observaci√≥n:</label>
                <input type="text" name="observacionEquipo" required>
              </div>

              <div class="form-row">
                <label>Descripci√≥n:</label>
                <div class="radio-group" style="display: flex; gap: 20px; margin-top: 8px;">
                  <label><input type="radio" name="descripcionEquipo" value="De Marca" checked> De Marca</label>
                  <label><input type="radio" name="descripcionEquipo" value="Compatible"> Compatible</label>
                  <label><input type="radio" name="descripcionEquipo" value="Otros"> Otros</label>
                </div>
              </div>
            `;

            contenedor.appendChild(form);
          }

          const btnGuardarTodos = document.createElement("button");
          btnGuardarTodos.textContent = "üíæ Guardar Todos los Equipos del Lote";
          btnGuardarTodos.classList.add("btn-guardar-lote");
          btnGuardarTodos.style.marginTop = "20px";
          btnGuardarTodos.style.padding = "10px 15px";
          btnGuardarTodos.style.backgroundColor = "#007bff";
          btnGuardarTodos.style.color = "white";
          btnGuardarTodos.style.border = "none";
          btnGuardarTodos.style.borderRadius = "5px";
          btnGuardarTodos.style.cursor = "pointer";

          btnGuardarTodos.addEventListener("click", async () => {
            const forms = contenedor.querySelectorAll("form");
            let errores = 0;
            let formulariosValidos = [];

            const seriesLote = new Set();
            const codigosLote = new Set();

            for (const form of forms) {
              const nombre = form.querySelector('[name="nombreEquipoInformatico"]').value.trim();
              const serie = form.querySelector('[name="numeroSerie"]').value.trim();
              const codigo = form.querySelector('[name="codigoPatrimonial"]').value.trim();
              const garantia = form.querySelector('[name="a√±oGarantia"]').value.trim();

              form.style.border = "none";
              let hayError = false;

              if (!nombre || !serie || !codigo || !garantia) {
                hayError = true;
                errores++;
                form.style.border = "2px solid red";
              }

              if (seriesLote.has(serie)) {
                hayError = true;
                errores++;
                form.style.border = "2px solid red";
              }

              if (codigosLote.has(codigo)) {
                hayError = true;
                errores++;
                form.style.border = "2px solid red";
              }

              if (!hayError) {
                seriesLote.add(serie);
                codigosLote.add(codigo);
                formulariosValidos.push(form);
              }
            }

            if (errores > 0) {
              alert(`‚ö†Ô∏è Corrige los errores en ${errores} formulario(s) antes de continuar.`);
              return;
            }

            let erroresEnvio = 0;
            for (const form of formulariosValidos) {
              const formData = new FormData(form);
              try {
                const response = await fetch(URL_CREAR_EQUIPO, {
                  method: "POST",
                  headers: {
                    "X-CSRFToken": csrfToken
                  },
                  body: formData
                });

                if (!response.ok) throw new Error("Error al guardar equipo");

                form.style.border = "2px solid green";
                form.querySelectorAll("input, button").forEach(el => el.disabled = true);
              } catch (error) {
                erroresEnvio++;
                form.style.border = "2px solid red";
                console.error(error);
              }
            }

            if (erroresEnvio === 0) {
              alert("‚úÖ Todos los equipos fueron registrados correctamente.");
              window.location.href = URL_LISTAR_EQUIPOS;
            } else {
              alert(`‚ö†Ô∏è Se detectaron errores en ${erroresEnvio} formulario(s) durante el registro.`);
            }
          });

          contenedor.appendChild(btnGuardarTodos);
          alert(`‚úÖ Lote registrado con ID: ${idLote}. Se generaron ${cantidad} formularios de equipos.`);
        } catch (error) {
          console.error("‚ùå Error al registrar lote:", error);
          alert("Error al registrar el lote. Intenta de nuevo.");
        }
      });
    }

    inicializarTabla();
  });


    // Funci√≥n para mostrar el formulario de edici√≥n
    function mostrarFormularioEdicion(equipo) {
      const form = document.getElementById("formularioEquipo");
      document.getElementById("formEquipo").style.display = "block";
      document.getElementById("modoFormulario").value = "editar";

      // Llenar campos
      document.getElementById("idEquipoInformatico").value = equipo.dataset.id;
      document.getElementById("nombre").value = equipo.dataset.nombre;
      document.getElementById("serie").value = equipo.dataset.serie;
      document.getElementById("patrimonio").value = equipo.dataset.patrimonio;
      document.getElementById("garantia").value = equipo.dataset.garantia;
      document.getElementById("observacion").value = equipo.dataset.observacion;
      document.getElementById("tipoHidden").value = equipo.dataset.tipo;
      document.getElementById("modelo").value = equipo.dataset.modelo;

      // Mostrar nombre en campo visible autocompletado
      const modeloInput = document.getElementById("modeloInput");
      const datalist = document.getElementById("listaModelos");
      const opcionSeleccionada = datalist.querySelector(`option[data-id='${equipo.dataset.modelo}']`);
      modeloInput.value = opcionSeleccionada?.value || "";

      // Seleccionar radio de descripci√≥n
      const radios = form.querySelectorAll("input[name='descripcionEquipo']");
      radios.forEach(radio => {
        radio.checked = (radio.value === equipo.dataset.descripcion);
      });

      // Mostrar imagen si existe
      const previewGrupo = document.getElementById("grupoImagenPreview");
      const imagen = document.getElementById("imagenPreview");
      if (opcionSeleccionada && opcionSeleccionada.dataset.imagen) {
        imagen.src = opcionSeleccionada.dataset.imagen;
        previewGrupo.style.display = "flex";
      } else {
        imagen.src = "";
        previewGrupo.style.display = "none";
      }

      // Cambiar acci√≥n del formulario (reemplazar esto si usas una vista espec√≠fica para editar)
      form.action = `/equipos-informaticos/editar/${equipo.dataset.id}/`;
    }

    // Eventos para todos los botones "Editar"
    document.querySelectorAll(".btn.amarillo").forEach(btn => {
      btn.addEventListener("click", () => {
        mostrarFormularioEdicion(btn);
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    });

    // Cancelar edici√≥n
    document.getElementById("btnCancelarFormulario").addEventListener("click", () => {
      document.getElementById("formEquipo").style.display = "none";
      document.getElementById("formularioEquipo").reset();
    });

</script>


{% endblock %}
